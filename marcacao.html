<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central de Marca√ß√£o</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #e9ecef; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR (LISTA) */
        .sidebar { width: 350px; background: white; border-right: 1px solid #ccc; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; background: #0056b3; color: white; }
        .sidebar-header h2 { margin: 0; font-size: 1.2rem; }
        .filter-box { padding: 10px; border-bottom: 1px solid #eee; }
        .filter-box input { width: 100%; padding: 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ddd; }
        
        .patient-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .card { 
            background: white; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; position: relative; 
            border-left: 5px solid #ccc; /* Cor padr√£o (Novo) */
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card.active { background-color: #e3f2fd; border-color: #0056b3; }
        
        /* Status Colors */
        .status-Novo { border-left-color: #6c757d; }
        .status-Tentativa { border-left-color: #ffc107; background-color: #fffbf0; }
        .status-Falha { border-left-color: #dc3545; opacity: 0.8; }
        .status-Agendado { border-left-color: #28a745; display: none; /* Esconde agendados por padr√£o */ }

        .p-name { font-weight: bold; display: block; margin-bottom: 4px; }
        .p-info { font-size: 0.85em; color: #666; }
        .badge { font-size: 0.75em; padding: 2px 6px; border-radius: 4px; background: #eee; float: right; }

        /* MAIN (DETALHES) */
        .main { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
        .detail-card { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); width: 100%; max-width: 600px; display: none; }
        
        .detail-header { border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px dashed #f0f0f0; padding-bottom: 5px; }
        .lbl { font-weight: bold; color: #555; }
        .val { color: #000; font-size: 1.1em; }

        /* A√ß√µes */
        .actions-area { margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; flex: 1; transition: 0.2s; }
        .btn-yellow { background: #ffc107; color: #333; }
        .btn-red { background: #dc3545; color: white; }
        .btn-green { background: #28a745; color: white; flex: 2; } /* Maior destaque */
        
        button:hover { opacity: 0.9; }
        
        .date-input-area { margin-top: 15px; display: none; animation: fadeIn 0.3s; }
        .date-input-area input { width: 100%; padding: 10px; font-size: 1.1em; border: 2px solid #28a745; border-radius: 4px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader */
        .loader { text-align: center; margin-top: 50px; color: #666; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>üìû Lista de Espera</h2>
            <small>Ordem de Cadastro</small>
        </div>
        <div class="filter-box">
            <input type="text" id="search" placeholder="Filtrar por nome...">
            <label style="font-size:0.8em; display:block; margin-top:5px;">
                <input type="checkbox" id="show-scheduled"> Mostrar j√° agendados
            </label>
        </div>
        <div class="patient-list" id="lista">
            <div class="loader">Carregando lista...</div>
        </div>
    </div>

    <div class="main">
        <div id="empty-state" style="text-align:center; color:#999; margin-top:100px;">
            <h3>Selecione um paciente na lista ao lado<br>para iniciar o contato.</h3>
        </div>

        <div class="detail-card" id="detalhes">
            <div class="detail-header">
                <h2 id="d-nome" style="margin:0; color:#0056b3;">Nome do Paciente</h2>
                <span id="d-status" class="badge" style="background:#ccc; margin-top:5px;">Novo</span>
            </div>

            <div class="detail-row"><span class="lbl">CPF:</span> <span class="val" id="d-cpf">-</span></div>
            <div class="detail-row"><span class="lbl">Nascimento:</span> <span class="val" id="d-nasc">-</span></div>
            <div class="detail-row"><span class="lbl">Nome da M√£e:</span> <span class="val" id="d-mae">-</span></div>
            
            <h4 style="margin-bottom:10px; color:#555;">üìû Contatos</h4>
            <div class="detail-row"><span class="lbl">Telefone 1:</span> <span class="val" id="d-tel1">-</span></div>
            <div class="detail-row"><span class="lbl">Telefone 2:</span> <span class="val" id="d-tel2">-</span></div>

            <div class="actions-area">
                <h4>Registrar Feedback do Contato:</h4>
                <div class="btn-group">
                    <button class="btn-yellow" onclick="salvarFeedback('Tentativa (N√£o atendeu)')">üìµ N√£o Atendeu</button>
                    <button class="btn-yellow" onclick="salvarFeedback('Tentativa (Ocupado)')">‚ö†Ô∏è Ocupado</button>
                    <button class="btn-red" onclick="salvarFeedback('Falha (N√∫mero Errado)')">‚ùå N√∫mero Errado</button>
                </div>
                
                <hr>
                
                <div class="btn-group">
                    <button class="btn-green" onclick="mostrarAgendamento()">‚úÖ Contato com Sucesso (Agendar)</button>
                </div>

                <div class="date-input-area" id="area-data">
                    <label>Selecione a Data do Agendamento:</label><br>
                    <input type="date" id="input-data-agenda">
                    <button class="btn-green" style="margin-top:10px; width:100%;" onclick="confirmarAgendamento()">CONFIRMAR DATA</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwAHWoSAyayko0rnW48JaCmxeEvPY8fVA05RCn5fELuNGVWuMHac2P9RAZ8R0u72Ix2/exec';
        let pacientes = [];
        let pacienteAtual = null;

        // 1. Carregar Lista
        window.onload = () => {
            fetch(scriptURL + "?action=lista_marcacao")
                .then(r => r.json())
                .then(data => {
                    pacientes = data;
                    renderizarLista(pacientes);
                });
        };

        // 2. Renderizar (com filtro)
        function renderizarLista(lista) {
            const container = document.getElementById('lista');
            const termo = document.getElementById('search').value.toLowerCase();
            const showScheduled = document.getElementById('show-scheduled').checked;

            container.innerHTML = "";

            lista.forEach(p => {
                // Filtros
                if (!p.nome.toLowerCase().includes(termo)) return;
                if (!showScheduled && p.status === 'Agendado') return;

                const card = document.createElement('div');
                card.className = `card status-${p.status || 'Novo'}`;
                if(p.status === 'Agendado') card.style.display = showScheduled ? 'block' : 'none';

                // √çcone baseado no status
                let icon = "‚ö™";
                if(p.status && p.status.includes("Tentativa")) icon = "üü°";
                if(p.status && p.status.includes("Falha")) icon = "üî¥";
                if(p.status === "Agendado") icon = "üü¢";

                card.innerHTML = `
                    <span class="badge">${p.status || 'Novo'}</span>
                    <span class="p-name">${p.nome}</span>
                    <span class="p-info">${icon} CPF: ${p.cpf}</span>
                `;
                
                card.onclick = () => abrirDetalhes(p, card);
                container.appendChild(card);
            });
        }

        // Filtro de busca
        document.getElementById('search').addEventListener('input', () => renderizarLista(pacientes));
        document.getElementById('show-scheduled').addEventListener('change', () => renderizarLista(pacientes));

        // 3. Abrir Detalhes
        function abrirDetalhes(p, cardElement) {
            pacienteAtual = p;
            
            // Highlight visual
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            cardElement.classList.add('active');

            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('detalhes').style.display = 'block';
            document.getElementById('area-data').style.display = 'none'; // Reseta √°rea de data

            // Preenche dados
            document.getElementById('d-nome').innerText = p.nome;
            document.getElementById('d-status').innerText = p.status || "Novo";
            document.getElementById('d-cpf').innerText = p.cpf;
            document.getElementById('d-nasc').innerText = p.nasc;
            document.getElementById('d-mae').innerText = p.mae;
            document.getElementById('d-tel1').innerText = p.tel1;
            document.getElementById('d-tel2').innerText = p.tel2;
        }

        // 4. Salvar Feedback (Sem agendar)
        function salvarFeedback(status) {
            if(!confirm(`Confirmar status: ${status}?`)) return;
            enviarDados(status, null);
        }

        // 5. Mostrar campo de data
        function mostrarAgendamento() {
            document.getElementById('area-data').style.display = 'block';
        }

        // 6. Confirmar Agendamento (Com data)
        function confirmarAgendamento() {
            const data = document.getElementById('input-data-agenda').value;
            if(!data) { alert("Escolha uma data!"); return; }
            enviarDados("Agendado", data);
        }

        // 7. Envio para o Script
        function enviarDados(statusNovo, dataAgenda) {
            // Bloqueia interface
            const btns = document.querySelectorAll('button');
            btns.forEach(b => b.disabled = true);
            document.body.style.cursor = "wait";

            const formData = new FormData();
            formData.append('action', 'salvar_marcacao');
            formData.append('linha_planilha', pacienteAtual.linha); // Fundamental para atualizar a linha certa
            formData.append('status_novo', statusNovo);
            
            if(dataAgenda) {
                formData.append('nome', pacienteAtual.nome);
                formData.append('cpf', pacienteAtual.cpf);
                formData.append('data_agendamento', dataAgenda);
            }

            fetch(scriptURL, { method: 'POST', body: formData })
                .then(r => r.json())
                .then(res => {
                    if(res.result === 'success') {
                        alert("Salvo com sucesso!");
                        location.reload();
                    } else {
                        alert("Erro ao salvar.");
                        btns.forEach(b => b.disabled = false);
                        document.body.style.cursor = "default";
                    }
                });
        }
    </script>

</body>
</html>
