<script>
        // COLOQUE SUA NOVA URL AQUI
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxN2Q9yAarhZNyoSMKWXk6330UMOmjYHFatE5nCqubfPHvcbcbiapk2EJ3bYXMsMJJX/exec'; 

        let pacientes = [];
        const datalist = document.getElementById('listaPacientes');
        const inputBusca = document.getElementById('buscaPaciente');

        // 1. Carrega lista ao abrir a página
        window.onload = () => {
            inputBusca.placeholder = "Carregando banco de dados...";
            
            // Chama a ação específica 'lista_completa'
            fetch(scriptURL + "?action=lista_completa")
                .then(r => r.json())
                .then(data => {
                    pacientes = data;
                    inputBusca.placeholder = "Digite Nome ou CPF...";
                    
                    data.forEach(p => {
                        let opt = document.createElement('option');
                        // Cria a opção de busca: "JOAO SILVA | CPF: 123..."
                        opt.value = `${p.nome} | CPF: ${p.cpf}`;
                        datalist.appendChild(opt);
                    });
                })
                .catch(err => {
                    alert("Erro ao carregar pacientes. Verifique o Script.");
                });
        };

        // 2. Quando seleciona um paciente
        inputBusca.addEventListener('input', function() {
            let val = this.value;
            // Procura na memória o paciente selecionado
            let p = pacientes.find(x => `${x.nome} | CPF: ${x.cpf}` === val);
            
            if(p) {
                document.getElementById('nomeFinal').value = p.nome;
                document.getElementById('cpfFinal').value = p.cpf;
            }
        });

        // 3. Salvar Agendamento
        function salvarAgendamento() {
            let nome = document.getElementById('nomeFinal').value;
            let cpf = document.getElementById('cpfFinal').value;
            let data = document.getElementById('dataAgenda').value;
            let btn = document.getElementById('btnSalvar');
            let msg = document.getElementById('msg');

            if(!nome || !data) { alert("Preencha todos os campos!"); return; }

            btn.disabled = true;
            btn.innerText = "Salvando...";

            let formData = new FormData();
            formData.append('action', 'agendar'); // Ação para salvar na aba Atendimentos
            formData.append('nome', nome);
            formData.append('cpf', cpf);
            formData.append('data_agendamento', data);

            fetch(scriptURL, { method: 'POST', body: formData })
                .then(r => r.json())
                .then(res => {
                    if(res.result === 'success') {
                        msg.innerText = "✅ Agendado com sucesso!";
                        msg.style.color = "green";
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        msg.innerText = "Erro ao salvar.";
                        btn.disabled = false;
                    }
                });
        }
    </script>
</body>
</html>
