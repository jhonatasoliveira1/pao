<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Atendimento - Além do Olhar</title>
    <style>
        :root {
            --primary-color: #28a745;
            --bg-color: #f4f7f6;
            --text-color: #333;
            --error-color: #dc3545;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-top: 5px solid var(--primary-color);
        }
        h1 { text-align: center; color: var(--primary-color); margin-bottom: 20px; }
        
        .form-group { margin-bottom: 20px; position: relative; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input:focus, select:focus { border-color: var(--primary-color); outline: none; }
        input[readonly] { background-color: #e9ecef; color: #555; }

        /* Estilo da Busca de Paciente */
        #status-busca { font-size: 0.85em; color: #666; margin-top: 5px; font-style: italic; }
        
        /* Botões de Sim/Não */
        .radio-group { display: flex; gap: 20px; }
        .radio-option { display: flex; align-items: center; cursor: pointer; }
        .radio-option input { width: auto; margin-right: 10px; transform: scale(1.5); }

        /* Área de Datas Múltiplas */
        .date-container { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-add { background-color: #6c757d; color: white; border: none; padding: 5px 15px; cursor: pointer; border-radius: 4px; font-size: 0.9em; }
        .btn-remove { background-color: #dc3545; color: white; border: none; padding: 0 15px; cursor: pointer; border-radius: 4px; }

        /* Áreas Condicionais */
        #areaAtendimento, #areaFalta, #divOutroMotivo {
            display: none;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid var(--primary-color);
            margin-top: 15px;
        }
        #areaFalta { border-left-color: #dc3545; }

        /* Estilo especial para 20/X */
        .acuidade-wrapper { display: flex; align-items: center; gap: 10px; }
        .prefixo-20 { font-size: 1.2em; font-weight: bold; color: #555; white-space: nowrap; }

        .btn-submit {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 30px;
        }
        .btn-submit:hover { background-color: #218838; }
        .btn-submit:disabled { background-color: #ccc; cursor: not-allowed; }

        #loading { display: none; text-align: center; margin-top: 15px; color: var(--primary-color); font-weight: bold; }
        #success-message { display: none; text-align: center; color: green; padding: 20px; border: 1px solid green; background: #e8f5e9; border-radius: 4px; margin-bottom: 20px;}

    </style>
</head>
<body>

<div class="container">
    <div id="success-message">
        <h3>Dados Salvos!</h3>
        <button onclick="location.reload()" style="margin-top:10px; padding:10px; cursor:pointer;">Novo Atendimento</button>
    </div>

    <form id="formAtendimento">
        <input type="hidden" name="pagina_destino" value="Atendimentos">
        <input type="hidden" name="Datas Agendamento" id="datasFinal">
        <input type="hidden" name="Motivo Falta" id="motivoFinal">

        <h1>FICHA DE ATENDIMENTO</h1>

        <div class="form-group" style="background: #eef5f9; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
            <label>Buscar Paciente (Digite Nome ou CPF):</label>
            <input type="text" list="listaPacientes" id="inputBusca" placeholder="Aguarde carregar lista..." disabled autocomplete="off">
            <span id="status-busca">Carregando lista de pacientes...</span>
            <datalist id="listaPacientes"></datalist>
        </div>

        <div class="form-group">
            <label>Nome do Paciente:</label>
            <input type="text" name="Nome Paciente" id="nomePaciente" readonly required>
        </div>

        <div style="display: flex; gap: 15px;">
            <div class="form-group" style="flex: 1;">
                <label>CPF:</label>
                <input type="text" name="CPF Paciente" id="cpfPaciente" readonly>
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Data de Nascimento:</label>
                <input type="text" name="Data Nascimento" id="nascPaciente" readonly>
            </div>
        </div>

        <div class="form-group">
            <label>Atendido por:</label>
            <input type="text" name="Atendido Por" required placeholder="Nome do profissional">
        </div>

        <div class="form-group">
            <label>Data(s) de Agendamento:</label>
            <div id="listaDatas">
                <div class="date-container">
                    <input type="date" class="input-data" required>
                </div>
            </div>
            <button type="button" class="btn-add" onclick="adicionarData()">+ Adicionar outra data</button>
        </div>

        <div class="form-group">
            <label>Paciente Compareceu?</label>
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="Compareceu" value="Sim" onclick="toggleComparecimento(true)" required> Sim
                </label>
                <label class="radio-option">
                    <input type="radio" name="Compareceu" value="Não" onclick="toggleComparecimento(false)"> Não
                </label>
            </div>
        </div>

        <div class="form-group">
            <label>Inclusão no projeto?</label>
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="Inclusão Projeto" value="Sim"> Sim
                </label>
                <label class="radio-option">
                    <input type="radio" name="Inclusão Projeto" value="Não"> Não
                </label>
            </div>
        </div>

        <div id="areaAtendimento">
            <h3>Dados Clínicos</h3>
            
            <div class="form-group">
                <label>Situação:</label>
                <input type="text" name="Situação">
            </div>

            <div class="form-group">
                <label>HD (Hipótese Diagnóstica):</label>
                <input type="text" name="HD">
            </div>

            <div class="form-group">
                <label>AVL (Acuidade Visual):</label>
                <select name="AVL">
                    <option value="">Selecione...</option>
                    <option value="C/C">C/C (Com Correção)</option>
                    <option value="S/C">S/C (Sem Correção)</option>
                </select>
            </div>

            <div style="display: flex; gap: 20px;">
                <div class="form-group" style="flex: 1;">
                    <label>OD (Olho Direito):</label>
                    <div class="acuidade-wrapper">
                        <span class="prefixo-20">20 /</span>
                        <input type="number" name="OD" placeholder="Ex: 20">
                    </div>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>OE (Olho Esquerdo):</label>
                    <div class="acuidade-wrapper">
                        <span class="prefixo-20">20 /</span>
                        <input type="number" name="OE" placeholder="Ex: 40">
                    </div>
                </div>
            </div>
        </div>

        <div id="areaFalta">
            <h3>Motivo da Ausência</h3>
            <div class="form-group">
                <select id="selectMotivo">
                    <option value="">Selecione o motivo...</option>
                    <option value="Não atende as ligações">Não atende as ligações</option>
                    <option value="Número de telefone com problemas">Número de telefone com problemas</option>
                    <option value="Endereço não localizado">Endereço não localizado</option>
                    <option value="Outros">Outros (Especificar)</option>
                </select>
            </div>

            <div id="divOutroMotivo" class="form-group">
                <label>Especifique o motivo:</label>
                <input type="text" id="inputOutroMotivo">
            </div>
        </div>

        <button type="submit" class="btn-submit">Salvar Atendimento</button>
        <p id="loading">Enviando dados...</p>

    </form>
</div>

<script>
    // --- COLE SUA URL DO APPS SCRIPT AQUI ---
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwZcmdDIlIAI0Miym0P6-5eg1fwa4hP-pfPG5djVmKC1eveEXra9_oZm32SAa-AMZTh/exec'; 

    // --- VARIÁVEIS GLOBAIS ---
    let pacientesData = []; // Guardará a lista baixada da planilha

    const form = document.getElementById('formAtendimento');
    const loading = document.getElementById('loading');
    const btn = document.querySelector('.btn-submit');
    const successMsg = document.getElementById('success-message');
    const inputBusca = document.getElementById('inputBusca');
    const statusBusca = document.getElementById('status-busca');
    const datalist = document.getElementById('listaPacientes');

    // 1. CARREGAR LISTA DE PACIENTES AO ABRIR (DO GET)
    window.onload = function() {
        fetch(scriptURL)
            .then(response => response.json())
            .then(data => {
                pacientesData = data;
                statusBusca.innerText = "Lista carregada. Digite para buscar.";
                statusBusca.style.color = "green";
                inputBusca.disabled = false;
                inputBusca.placeholder = "Digite Nome ou CPF...";
                
                // Preenche o datalist
                pacientesData.forEach(p => {
                    const option = document.createElement('option');
                    // O valor que aparece na lista
                    option.value = `${p.nome} (CPF: ${p.cpf})`;
                    datalist.appendChild(option);
                });
            })
            .catch(error => {
                console.error(error);
                statusBusca.innerText = "Erro ao carregar lista de pacientes.";
                statusBusca.style.color = "red";
            });
    };

    // 2. EVENTO DE SELEÇÃO NA BUSCA
    inputBusca.addEventListener('input', function() {
        const val = this.value;
        // Tenta achar o paciente na lista baseada no texto inputado
        // A lógica do datalist do HTML coloca o valor exato do option no input quando seleciona
        
        // Vamos procurar na nossa lista em memória
        const pacienteEncontrado = pacientesData.find(p => `${p.nome} (CPF: ${p.cpf})` === val);

        if (pacienteEncontrado) {
            document.getElementById('nomePaciente').value = pacienteEncontrado.nome;
            document.getElementById('cpfPaciente').value = pacienteEncontrado.cpf;
            document.getElementById('nascPaciente').value = pacienteEncontrado.nascimento;
        } else {
            // Se apagou ou digitou algo novo, limpa (opcional, pode deixar travar)
            // document.getElementById('nomePaciente').value = "";
            // document.getElementById('cpfPaciente').value = "";
            // document.getElementById('nascPaciente').value = "";
        }
    });


    // Lógica para Adicionar Múltiplas Datas
    function adicionarData() {
        const container = document.getElementById('listaDatas');
        const div = document.createElement('div');
        div.className = 'date-container';
        div.innerHTML = `
            <input type="date" class="input-data" required>
            <button type="button" class="btn-remove" onclick="this.parentElement.remove()">X</button>
        `;
        container.appendChild(div);
    }

    // Lógica Compareceu (Sim/Não)
    function toggleComparecimento(compareceu) {
        const areaSim = document.getElementById('areaAtendimento');
        const areaNao = document.getElementById('areaFalta');
        const camposSim = areaSim.querySelectorAll('input, select');
        const selectNao = document.getElementById('selectMotivo');

        if (compareceu) {
            areaSim.style.display = 'block';
            areaNao.style.display = 'none';
            selectNao.value = ""; 
        } else {
            areaSim.style.display = 'none';
            areaNao.style.display = 'block';
            camposSim.forEach(c => c.value = "");
        }
    }

    // Lógica "Outros" no Motivo
    const selectMotivo = document.getElementById('selectMotivo');
    const divOutroMotivo = document.getElementById('divOutroMotivo');
    
    selectMotivo.addEventListener('change', function() {
        if (this.value === 'Outros') {
            divOutroMotivo.style.display = 'block';
        } else {
            divOutroMotivo.style.display = 'none';
            document.getElementById('inputOutroMotivo').value = "";
        }
    });

    // Envio do Formulário
    form.addEventListener('submit', e => {
        e.preventDefault();

        // 1. Juntar Datas
        const inputsDatas = document.querySelectorAll('.input-data');
        const listaDatas = Array.from(inputsDatas).map(input => input.value).filter(val => val);
        document.getElementById('datasFinal').value = listaDatas.join('; ');

        // 2. Definir Motivo Final
        if (selectMotivo.value === 'Outros') {
            document.getElementById('motivoFinal').value = document.getElementById('inputOutroMotivo').value;
        } else {
            document.getElementById('motivoFinal').value = selectMotivo.value;
        }

        loading.style.display = 'block';
        btn.disabled = true;
        btn.style.opacity = '0.5';

        fetch(scriptURL, { method: 'POST', body: new FormData(form)})
            .then(response => {
                loading.style.display = 'none';
                form.style.display = 'none';
                successMsg.style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Error!', error.message);
                loading.innerText = "Erro na conexão.";
                btn.disabled = false;
                btn.style.opacity = '1';
            });
    });
</script>

</body>
</html>
